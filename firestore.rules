
/**
 * Core Philosophy:
 * This ruleset enforces a strict security model based on user ownership and global administrative roles.
 * User-specific data (lessons) is protected, while global data (instructors, horses) is managed by admins.
 *
 * Data Structure:
 * A top-level `/lessons` collection stores all lesson bookings. Each lesson document contains a `userId` field
 * to link it to the owner, enabling per-user security rules.
 * Global data like instructors, horses, and admin roles are in their own top-level collections.
 *
 * Key Security Decisions:
 * - Admin Roles: A global admin role is implemented by checking for a user's UID in the `/admins/{userId}`
 *   collection. This provides a centralized and clear way to manage administrative privileges.
 * - Lesson Security:
 *   - Admins can read and write all lessons for management purposes.
 *   - Authenticated users can create lessons for themselves (`request.resource.data.userId == request.auth.uid`).
 *   - Users can only read, update, or delete their own lessons (`resource.data.userId == request.auth.uid`).
 *   - Listing the entire collection is restricted to admins to prevent data leakage.
 * - Publicly Readable Data: The /instructors and /horses collections are readable by any authenticated user
 *   to allow them to make booking decisions, but write access is strictly controlled by admins.
 *
 * Denormalization for Authorization:
 * The `userId` field is denormalized and stored in each lesson document. This is crucial for writing
 * secure and efficient rules, as it allows direct validation of ownership without needing complex joins or queries.
 *
 * Structural Segregation:
 * The data model correctly segregates user-centric data (/lessons) from globally managed data
 * (/instructors, /horses), which allows for distinct and highly secure access controls for each collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * This is the foundation of the user-ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the requesting user is a global administrator.
     * Admin status is granted if a document with the user's UID exists in the /admins collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    /**
     * Checks if the user has an 'Instructor' or 'Manager' role in their user profile.
     */
    function isStaff() {
        let userProfile = get(/databases/$(database)/documents/users/$(request.auth.uid));
        return isSignedIn() && (userProfile.data.role == 'Instructor' || userProfile.data.role == 'Manager');
    }

    /**
     * Verifies that a document exists before an update or delete operation.
     * This prevents operations on non-existent documents.
     */
    function isExistingDoc() {
      return resource != null;
    }
    
    /**
     * Validates that the lesson being created is for the currently signed-in user.
     */
    function isCreatingOwnLesson() {
      return request.resource.data.userId == request.auth.uid;
    }

    /**
     * Validates that the lesson being accessed belongs to the currently signed-in user.
     */
    function isAccessingOwnLesson() {
      return resource.data.userId == request.auth.uid;
    }
    
    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------
    
    /**
     * @description Manages user profiles and roles.
     * @path        /users/{userId}
     * @allow       (create) Any signed-in user can create their own user profile document.
     * @allow       (read) A user can read their own profile. Admins can read any profile.
     * @allow       (update) A user can update their own profile.
     * @deny        (delete) No one can delete a user profile from the client.
     * @deny        (list) Listing all users is disallowed to protect user privacy.
     */
    match /users/{userId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow update: if isOwner(userId) && isExistingDoc();
      allow delete: if false;
    }

    /**
     * @description Manages admin role documents. This collection should be empty or contain
     *              documents where the ID is the UID of an admin user.
     *              This collection should ONLY be managed via the Firebase Console.
     * @path        /admins/{userId}
     * @deny        Any client attempting to read or write to this collection.
     */
    match /admins/{userId} {
      allow read, write: if false;
    }

    /**
     * @description Top-level collection for all lessons.
     * @path        /lessons/{lessonId}
     * @allow       (read) A user can read their own lesson. Staff/Admins can read any lesson.
     * @allow       (list) Staff/Admins can list all lessons. Users can list their own lessons (requires query with where clause).
     * @allow       (create) A user can create a lesson for themselves.
     * @allow       (update, delete) A user can modify their own lesson. Staff/Admins can modify any.
     */
    match /lessons/{lessonId} {
      allow get: if isAccessingOwnLesson() || isStaff() || isAdmin();
      allow list: if isStaff() || isAdmin(); // Users must query with `where('userId', '==', request.auth.uid)`
      allow create: if isCreatingOwnLesson();
      allow update, delete: if isAccessingOwnLesson() || isStaff() || isAdmin();
    }

    /**
     * @description Instructor profiles, viewable by all, managed by administrators.
     * @path        /instructors/{instructorId}
     * @allow       (read) Any authenticated user can view instructor profiles.
     * @allow       (write) Authenticated admins only.
     */
    match /instructors/{instructorId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * @description Horse profiles, viewable by all, managed by administrators.
     * @path        /horses/{horseId}
     * @allow       (read) Any authenticated user can view horse profiles.
     * @allow       (write) Authenticated admins only.
     */
    match /horses/{horseId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    /**
     * @description Payment information, managed exclusively by administrators.
     * @path        /payments/{paymentId}
     * @allow       (read, write) Authenticated admins only.
     * @deny        Any non-admin user.
     */
    match /payments/{paymentId} {
      allow read, write: if isAdmin();
    }
    
    /**
     * @description Museum rental bookings.
     * @path        /museumRentals/{rentalId}
     * @allow       (create) Any signed-in user can book a rental.
     * @allow       (read, list) Only admins can view rental information.
     * @allow       (update, delete) Only admins can modify or cancel rentals.
     */
    match /museumRentals/{rentalId} {
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow read, list, update, delete: if isAdmin();
    }

    /**
     * @description Stores instructor weekly availability.
     * @path        /availability/{availabilityId}
     * @allow       (read) Authenticated users can read availability to book lessons.
     * @allow       (create, update, delete) Instructors can manage their own availability.
     */
    match /availability/{availabilityId} {
        allow read: if isSignedIn();
        allow write: if isStaff() && request.resource.data.instructorId == request.auth.uid;
    }
  }
}

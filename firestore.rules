rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getRole(userId) {
      // Safely get the user's role, default to 'Rider' if document doesn't exist
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isAdmin() {
      return isSignedIn() && getRole(request.auth.uid) == 'Admin';
    }

    function isManager() {
      let userRole = getRole(request.auth.uid);
      return isSignedIn() && (userRole == 'Admin' || userRole == 'Manager');
    }

    function isInstructor() {
      let userRole = getRole(request.auth.uid);
      return isSignedIn() && (userRole == 'Admin' || userRole == 'Manager' || userRole == 'Instructor');
    }

    // Public Collections: Horses and Instructors are publicly readable
    match /horses/{horseId} {
      allow get, list: if true;
      allow write: if isManager(); // Only managers/admins can modify
    }

    match /instructors/{instructorId} {
      allow get, list: if true;
      allow write: if isManager(); // Only managers/admins can modify
    }

    // User data is private
    match /users/{userId} {
      allow get: if isOwner(userId) || isManager();
      allow list: if isManager();
      allow create: if (isOwner(userId) && request.resource.data.role == 'Rider') || isAdmin();
      allow update: if (isOwner(userId) && request.resource.data.role == resource.data.role) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Customer data is private to the user or managers
     match /customers/{customerId} {
      allow get, update, delete: if (isSignedIn() && isOwner(customerId)) || isManager();
      allow create: if isSignedIn() && isOwner(customerId);
      allow list: if isManager();
    }

    // Lessons have role-based access
    match /lessons/{lessonId} {
      // A user can get their own lesson, an instructor can get their assigned lesson, managers/admins see all
      allow get: if (isSignedIn() && resource.data.userId == request.auth.uid) || isInstructor() || isManager();
      // Instructors, Managers, and Admins can list lessons
      allow list: if isInstructor(); 
      // A signed-in user can create a lesson for themselves
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      // Users can update their own lesson (e.g. cancel), instructors can update assigned lessons, managers can update any
      allow update: if (isSignedIn() && resource.data.userId == request.auth.uid) || (isInstructor() && resource.data.instructorId == request.auth.uid) || isManager();
      // Users can delete their own, managers can delete any
      allow delete: if (isSignedIn() && resource.data.userId == request.auth.uid) || isManager();
    }

    // Availability can be managed by instructors for themselves, or by managers
    match /availability/{availabilityId} {
      allow get, list: if isSignedIn(); // Any logged in user can see availability to book
      allow create: if isInstructor() && request.resource.data.instructorId == request.auth.uid;
      allow update: if (isInstructor() && resource.data.instructorId == request.auth.uid) || isManager();
      allow delete: if isManager();
    }

    // Museum Rentals
    match /museumRentals/{rentalId} {
        allow get, list: if isManager();
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isManager();
    }

    // Team chat is for instructors and managers
    match /team-chat/{messageId} {
      allow read, create: if isInstructor();
      // Messages are immutable
      allow update, delete: if false;
    }
  }
}
